<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MrMasage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .app {
            width: 100%;
            max-width: 400px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-screen {
            padding: 40px 20px;
            text-align: center;
        }
        .auth-screen h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .auth-form input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        .auth-btn:hover {
            background: #764ba2;
        }
        .switch-auth {
            margin-top: 20px;
            color: #666;
            cursor: pointer;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .chat-header {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        .logout-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        .messages-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 15px;
            word-wrap: break-word;
        }
        .my-message {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .other-message {
            background: white;
            border: 1px solid #ddd;
            border-bottom-left-radius: 5px;
        }
        .message-sender {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        .message-image {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 5px;
        }
        .input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
        }
        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            margin-right: 10px;
        }
        .send-btn, .file-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-input {
            display: none;
        }
        .online-users {
            padding: 10px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div class="auth-screen" id="authScreen">
            <h1>üí¨ Real Messenger</h1>
            <div class="auth-form">
                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="auth-btn" onclick="login()">–í–æ–π—Ç–∏</button>
                <div class="switch-auth" onclick="showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
            </div>
            
            <div class="auth-form" id="registerForm" style="display: none;">
                <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="auth-btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div class="switch-auth" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="logout-btn" onclick="logout()">üö™</button>
                <h2>Real Messenger</h2>
                <div>–û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></div>
            </div>
            
            <div class="online-users">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω: <span id="usersList"></span>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <input type="file" class="file-input" id="fileInput" accept="image/*">
                <button class="file-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é)
        const firebaseConfig = {
  apiKey: "AIzaSyCLmI4Ju5vsw3VY8VEvUpwm1g3Cliw_v14",
  authDomain: "mrmeseg-11034.firebaseapp.com",
  databaseURL: "https://mrmeseg-11034-default-rtdb.firebaseio.com",
  projectId: "mrmeseg-11034",
  storageBucket: "mrmeseg-11034.firebasestorage.app",
  messagingSenderId: "704296390245",
  appId: "1:704296390245:web:d6f6d35d3d88d84566c08c",
  measurementId: "G-FT6RCWET63"
};
        

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUser = null;

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function showRegister() {
            document.getElementById('authScreen').querySelector('.auth-form').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('authScreen').querySelector('.auth-form').style.display = 'block';
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await database.ref('users/' + user.uid).set({
                    username: username,
                    email: email,
                    createdAt: Date.now()
                });
                
                showChat(user);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –í—Ö–æ–¥
        async function login() {
            const email = document.getElementById('loginUsername').value + '@messenger.com';
            const password = document.getElementById('loginPassword').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                showChat(userCredential.user);
            } catch (error) {
                // –ï—Å–ª–∏ –≤—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏
                try {
                    const snapshot = await database.ref('users').orderByChild('username').equalTo(document.getElementById('loginUsername').value).once('value');
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const userId = Object.keys(users)[0];
                        const userEmail = users[userId].email;
                        
                        const userCredential = await auth.signInWithEmailAndPassword(userEmail, password);
                        showChat(userCredential.user);
                    } else {
                        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                } catch (error2) {
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç
        function showChat(user) {
            currentUser = user;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserData();
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();
            // –°–ª–µ–¥–∏–º –∑–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–æ–º
            setupPresence();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentUser.username = userData.username;
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
        function setupPresence() {
            const userStatusRef = database.ref('status/' + currentUser.uid);
            const connectedRef = database.ref('.info/connected');
            
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val()) {
                    userStatusRef.onDisconnect().set('offline');
                    userStatusRef.set('online');
                }
            });

            // –°–ª–µ–¥–∏–º –∑–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            database.ref('status').on('value', (snapshot) => {
                const statuses = snapshot.val();
                let onlineUsers = [];
                let onlineCount = 0;
                
                for (const userId in statuses) {
                    if (statuses[userId] === 'online') {
                        onlineCount++;
                        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        database.ref('users/' + userId + '/username').once('value', (userSnapshot) => {
                            if (userSnapshot.exists() && userId !== currentUser.uid) {
                                onlineUsers.push(userSnapshot.val());
                                document.getElementById('usersList').textContent = onlineUsers.join(', ');
                            }
                        });
                    }
                }
                
                document.getElementById('onlineCount').textContent = onlineCount - 1; // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages() {
            const messagesRef = database.ref('messages').limitToLast(50);
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message);
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const fileInput = document.getElementById('fileInput');
            const text = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!text && !file) return;

            let imageUrl = null;

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            if (file) {
                try {
                    const storageRef = storage.ref('images/' + Date.now() + '_' + file.name);
                    const snapshot = await storageRef.put(file);
                    imageUrl = await snapshot.ref.getDownloadURL();
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                    return;
                }
            }

            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const message = {
                text: text,
                imageUrl: imageUrl,
                senderId: currentUser.uid,
                senderName: currentUser.username || '–ê–Ω–æ–Ω–∏–º',
                timestamp: Date.now()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            await database.ref('messages').push(message);

            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            messageInput.value = '';
            fileInput.value = '';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'my-message' : 'other-message'}`;
            
            let messageHTML = '';
            if (message.senderId !== currentUser.uid) {
                messageHTML += `<div class="message-sender">${message.senderName}</div>`;
            }
            
            if (message.text) {
                messageHTML += `<div>${message.text}</div>`;
            }
            
            if (message.imageUrl) {
                messageHTML += `<img src="${message.imageUrl}" class="message-image" onclick="openImage('${message.imageUrl}')">`;
            }
            
            messageDiv.innerHTML = messageHTML;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
        function openImage(url) {
            window.open(url, '_blank');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                sendMessage();
            }
        });

        // –í—ã—Ö–æ–¥
        function logout() {
            auth.signOut();
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'block';
            currentUser = null;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
        auth.onAuthStateChanged((user) => {
            if (user) {
                showChat(user);
            }
        });
    </script>
</body>
  </html>
